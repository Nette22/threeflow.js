(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w=function(a,b){return function(){return a.apply(b,arguments)}},x={}.hasOwnProperty,y=function(a,b){function c(){this.constructor=a}for(var d in b)x.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};u=window.THREE||{},u.SF={},u.SunflowRenderer=s=function(){function a(a){this.onRenderComplete=w(this.onRenderComplete,this),this.onRenderProgress=w(this.onRenderProgress,this),this.onRenderStart=w(this.onRenderStart,this),this.onConnected=w(this.onConnected,this),a=a||{},this.port=a.port||3e3,this.host=a.host||"http://localhost",this.exporter=new f,this.connected=!1,this.rendering=!1,this.gui=new DatGUI(this)}return a.prototype.connect=function(){return this.connected?void 0:(this.socket=io.connect(this.host),this.socket.on("connected",this.onConnected),this.socket.on("renderstart",this.onRenderStart),this.socket.on("renderprogress",this.onRenderProgress),this.socket.on("rendercomplete",this.onRenderComplete),null)},a.prototype.render=function(a,b,c,d){var e,f;if(!this.connected)throw new Error("[SunflowRenderer] Call connect() before rendering.");return this.rendering?console.log("QUEUE?"):(console.log("RENDER"),f=1,this.exporter.blockExporters[0].settings.resolutionX=c*f,this.exporter.blockExporters[0].settings.resolutionY=d*f,this.exporter.indexScene(a),e=this.exporter.exportCode(),this.socket.emit("render",{scFile:e})),null},a.prototype.onConnected=function(){return console.log("Sunflow conected."),this.connected=!0,null},a.prototype.onRenderStart=function(){return console.log("onRenderStart"),null},a.prototype.onRenderProgress=function(){return console.log("onRenderProgress"),null},a.prototype.onRenderComplete=function(){return console.log("onRenderComplete"),null},a}(),a=function(){function a(){}return a.prototype.addToIndex=function(){throw new Error("BlockExporter subclasses must override this method.")},a.prototype.doTraverse=function(){throw new Error("BlockExporter subclasses must override this method.")},a.prototype.exportBlock=function(){throw new Error("BlockExporter subclasses must override this method.")},a.prototype.exportColorTHREE=function(a){return'{ "sRGB nonlinear" '+a.r+" "+a.g+" "+a.b+" }"},a.prototype.exportColorHex=function(a){var b,c,d;return d=(a>>16&255)/255,c=(a>>8&255)/255,b=(255&a)/255,'{ "sRGB nonlinear" '+d+" "+c+" "+b+" }"},a.prototype.exportVector=function(a){return a.x+" "+a.y+" "+a.z},a.prototype.exportFace=function(a){return a.a+" "+a.b+" "+a.c},a.prototype.exportTransform=function(a){var b,c,d,e,f;for(c="",f=a.matrixWorld.elements,d=0,e=f.length;e>d;d++)b=f[d],c+=" "+b;return c},a.prototype.exportTransformPosition=function(a){var b,c;return c="",b=a.matrixWorld.elements,c+=b[12]+" "+b[13]+" "+b[14]},a}(),b=function(a){function b(){b.__super__.constructor.call(this),this.settings={enabled:!0},this.camera=null,console.log(this)}return y(b,a),b.prototype.addToIndex=function(a){return this.camera?void 0:(a instanceof u.PerspectiveCamera&&(this.camera=a,console.log("SET CAMERA",this.camera)),null)},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a;return a="",this.settings.enabled&&this.camera?(a+="camera {\n",a+="  type pinhole\n",a+="  eye "+this.exportVector(this.camera.position)+"\n",a+="  target "+this.exportVector(this.camera.rotation)+"\n",a+="  up "+this.exportVector(this.camera.up)+"\n",a+="  fov "+this.camera.fov*this.camera.aspect+"\n",a+="  aspect "+this.camera.aspect+"\n",a+="}\n\n"):a},b}(a),c=function(a){function b(){b.__super__.constructor.call(this),this.settings={enabled:!1,photons:1e4,kdEstimate:100,kdRadius:.5}}return y(b,a),b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a;return a="",this.settings.enabled?(a+="photons {\n",a+="  caustics "+this.settings.photons+" kd "+this.settings.kdEstimate+" "+this.settings.kdRadius+"\n",a+="}\n\n"):a},b}(a),f=function(){function d(){this.exporterSettings={convertPrimitives:!1},this.blockExporters=[],this.addBlockExporter(new j),this.addBlockExporter(new v),this.addBlockExporter(new c),this.addBlockExporter(new h),this.addBlockExporter(new b),this.addBlockExporter(new k),this.addBlockExporter(new l),this.addBlockExporter(new g),this.addBlockExporter(new m)}return d.BUCKET_ORDERS=["hilbert","spiral","column","row","diagonal","random"],d.prototype.addBlockExporter=function(b){if(!b instanceof a)throw new Error("Extend BlockExporter");return this.blockExporters.push(b)},d.prototype.indexScene=function(a){var b,c,d,e,f,g,h,i,j;if(a.children.length)for(i=a.children,e=0,g=i.length;g>e;e++){for(c=i[e],d=!0,j=this.blockExporters,f=0,h=j.length;h>f;f++)b=j[f],b.addToIndex(c),d=d&&b.doTraverse(c);d&&this.indexScene(c)}return null},d.prototype.exportCode=function(){var a,b,c,d,e;for(b="",e=this.blockExporters,c=0,d=e.length;d>c;c++)a=e[c],b+=a.exportBlock();return b},d}(),g=function(a){function b(){b.__super__.constructor.call(this),this.settings={enabled:!0},this.geometryIndex={}}return y(b,a),b.prototype.addToIndex=function(a){return a instanceof u.Mesh&&a.geometry&&!this.geometryIndex[a.geometry.uuid]&&(this.geometryIndex[a.geometry.uuid]=a.geometry),null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b,c,d,e,f,g,h,i,j,k;if(c="",!this.settings.enabled)return c;for(d in this.geometryIndex){for(b=this.geometryIndex[d],c+="object {\n",c+="  noinstance\n",c+="  type generic-mesh\n",c+="  name "+b.uuid+"\n",c+="  points "+b.vertices.length+"\n",j=b.vertices,f=0,h=j.length;h>f;f++)e=j[f],c+="    "+this.exportVector(e)+"\n";for(c+="  triangles "+b.faces.length+"\n",k=b.faces,g=0,i=k.length;i>g;g++)a=k[g],c+="    "+this.exportFace(a)+"\n";c+="  normals none\n",c+="  uvs none\n",c+="}\n\n"}return c},b}(a),h=function(a){function b(){this.type=b.TYPES[0],this.enabled=!1,this.irrCacheSettings={samples:512,tolerance:.01,spacingMin:.05,spacingMax:5,globalEnabled:!1,globalPhotons:1e4,globalMap:b.GLOBAL_MAP_TYPES[0],globalEstimate:100,globalRadius:.75},this.igiSettings={samples:64,sets:1,bias:.01,biasSamples:0},this.pathSettings={samples:32},this.ambOccSettings={samples:32,bright:16777215,dark:0,maxDistance:3},this.fakeSettings={upX:0,upY:1,upZ:0,sky:0,ground:16777215}}return y(b,a),b.GLOBAL_MAP_TYPES=["grid","path"],b.TYPES=["igi","irr-cache","path","ambocc","fake"],b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b;return b="",this.enabled?(b+="gi {\n",b+="  type "+this.type+"\n","igi"===this.type?(b+="  samples "+this.igiSettings.samples+"\n",b+="  sets "+this.igiSettings.sets+"\n",b+="  b "+this.igiSettings.bias+"\n",b+="  bias-samples "+this.igiSettings.biasSamples+"\n"):"irr-cache"===this.type?(b+="  samples "+this.irrCacheSettings.samples+"\n",b+="  tolerance "+this.irrCacheSettings.tolerance+"\n",b+="  spacing "+this.irrCacheSettings.spacingMin+" "+this.irrCacheSettings.spacingMax+"\n",this.irrCacheSettings.globalEnabled&&(a="global ",a+=this.irrCacheSettings.globalPhotons+" ",a+=this.irrCacheSettings.globalMap+" ",a+=this.irrCacheSettings.globalEstimate+" ",a+=this.irrCacheSettings.globalRadius+"\n",b+=a)):"path"===this.type?b+="samples "+this.pathSettings.samples+"\n":"ambocc"===this.type?(b+='bright { "sRGB nonlinear" 1 1 1 }\n',b+='dark { "sRGB nonlinear" 0 0 0 }\n',b+="samples "+this.ambOccSettings.samples+"\n",b+="maxdist "+this.ambOccSettings.maxDistance+"\n"):"fake"===this.type&&(b+="up "+this.ambOccSettings.upX+" "+this.ambOccSettings.upY+" "+this.ambOccSettings.upZ,b+='sky { "sRGB nonlinear" 0 0 0 }',b+='ground { "sRGB nonlinear" 1 1 1 }'),b+="}\n\n"):b},b}(a),j=function(a){function b(){b.__super__.constructor.call(this),this.settings={resolutionX:800,resolutionY:600,antialiasMin:-1,antialiasMax:1,samples:8,contrast:.1,filter:b.FILTERS[1],jitter:!0}}return y(b,a),b.FILTERS=["box","triangle","gaussian","mitchell","catmull-rom","blackman-harris","sinc","lanczos","ospline"],b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a;return a="",a+="image {\n",a+="  resolution "+this.settings.resolutionX+" "+this.settings.resolutionY+"\n",a+="  aa "+this.settings.antialiasMin+" "+this.settings.antialiasMax+"\n",a+="  samples "+this.settings.samples+"\n",a+="  contrast "+this.settings.contrast+"\n",a+="  filter "+this.settings.filter+"\n",a+="  jitter "+this.settings.jitter+"\n",a+="}\n\n"},b}(a),k=function(a){function b(){b.__super__.constructor.call(this),this.settings={enabled:!0,sunskyEnabled:!0,sunskyUpX:0,sunskyUpY:1,sunskyUpZ:0,sunskyEastX:0,sunskyEastY:0,sunskyEastZ:1,sunskyDirX:1,sunskyDirY:1,sunskyDirZ:1,sunskyTurbidity:6,sunskySamples:64},this.lightIndex={}}return y(b,a),b.prototype.addToIndex=function(a){return a instanceof u.Light&&!this.lightIndex[a.uuid]&&(this.lightIndex[a.uuid]=a),null},b.prototype.doTraverse=function(a){return!(a instanceof u.SF.PointLight)},b.prototype.exportBlock=function(){var a,b,c;if(b="",!this.settings.enabled)return b;this.settings.sunskyEnabled&&(b+="light {\n",b+="  type sunsky\n",b+="  up "+this.settings.sunskyUpX+" "+this.settings.sunskyUpY+" "+this.settings.sunskyUpZ+"\n",b+="  east "+this.settings.sunskyEastX+" "+this.settings.sunskyEastY+" "+this.settings.sunskyEastZ+"\n",b+="  sundir "+this.settings.sunskyDirX+" "+this.settings.sunskyDirY+" "+this.settings.sunskyDirZ+"\n",b+="  turbidity "+this.settings.sunskyTurbidity+"\n",b+="  samples "+this.settings.sunskySamples+"\n",b+="}\n\n");for(c in this.lightIndex)a=this.lightIndex[c],a instanceof u.SF.PointLight&&(b+="light {\n",b+="  type point\n",b+="  color "+this.exportColorTHREE(a.color)+"\n",b+="  power "+200*a.intensity+" \n",b+="  p "+this.exportVector(a.position)+"\n"),b+="}\n\n";return b},b}(a),l=function(a){function b(){b.__super__.constructor.call(this),this.settings={enabled:!0},this.materialsIndex={}}return y(b,a),b.prototype.addToIndex=function(a){return a instanceof u.Mesh&&a.material&&!this.materialsIndex[a.material.uuid]&&(this.materialsIndex[a.material.uuid]=a.material),null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b,c;if(b="",!this.settings.enabled)return b;for(c in this.materialsIndex)a=this.materialsIndex[c],b+="shader {\n",b+="  name "+a.uuid+"\n",a instanceof u.SF.ConstantMaterial||a instanceof u.MeshBasicMaterial?(b+="  type constant\n",b+="  color "+this.exportColorTHREE(a.color)+"\n"):a instanceof u.SF.DiffuseMaterial||a instanceof u.MeshLambertMaterial?(b+="  type diffuse\n",b+="  diff "+this.exportColorTHREE(a.color)+"\n"):a instanceof u.SF.ShinyMaterial?(b+="  type shiny\n",b+="  diff "+this.exportColorTHREE(a.color)+"\n",b+="  refl "+a.reflection+"\n"):a instanceof u.SF.GlassMaterial?(b+="  type glass\n",b+="  eta "+a.eta+"\n",b+="  color "+this.exportColorTHREE(a.color)+"\n"):a instanceof u.SF.MirrorMaterial?(b+="  type mirror\n",b+="  refl "+this.exportColorTHREE(a.reflection)+"\n"):(a instanceof u.SF.PhongMaterial||a instanceof u.MeshPhongMaterial)&&(b+="  type phong\n",b+="  diff "+this.exportColorTHREE(a.color)+"\n",b+="  spec "+this.exportColorTHREE(a.specular)+" "+a.shininess+"\n",b+="  samples "+(a.samples||4)+"\n"),b+="}\n\n";return b},b}(a),m=function(a){function b(){b.__super__.constructor.call(this),this.settings={enabled:!0,convertPrimitives:!0},this.meshIndex={}}return y(b,a),b.prototype.addToIndex=function(a){return a instanceof u.Mesh&&!this.meshIndex[a.uuid]&&(this.meshIndex[a.uuid]=a),null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a,b,c;if(b="",!this.settings.enabled)return b;for(c in this.meshIndex)a=this.meshIndex[c],a.geometry instanceof u.SF.InfinitePlaneGeometry?(b+="object {\n",b+="  shader "+a.material.uuid+"\n",b+="  type plane\n",b+="  p "+this.exportTransformPosition(a)+"\n",b+="  n "+this.exportVector(a.rotation)+"\n"):this.settings.convertPrimitives&&a.geometry instanceof u.SphereGeometry?(b+="object {\n",b+="  shader "+a.material.uuid+"\n",b+="  type sphere\n",b+="  name "+a.uuid+"\n",b+="  c "+this.exportTransformPosition(a)+"\n",b+="  r "+a.geometry.radius+"\n"):(b+="instance {\n",b+="  name "+a.uuid+"\n",b+="  geometry "+a.geometry.uuid+"\n",b+="  transform col"+this.exportTransform(a)+"\n",b+="  shader "+a.material.uuid+"\n"),b+="}\n\n";return b},b}(a),q=function(){function a(){}return a["export"]=function(b,c,d,e){var f,g;return f=a.buildIndex(b),g="\n% Three.js generated Sunflow scene file.\n",g+="image {\n",g+="  resolution "+d+" "+e+"\n",g+="  aa 0 1\n",g+="  filter triangle\n",g+="}\n\n",g+="light {\n",g+="  type sunsky\n",g+="  up 0 1 0\n",g+="  east 0 0 1\n",g+="  sundir 1 1 1\n",g+="  turbidity 4\n",g+="  samples 64\n",g+="}\n\n",g+=this.exportCamera(c),g+=this.exportShaders(f),g+=this.exportObjects(f),a.disposeIndex(f),g},a.buildIndex=function(a){var b,c,d,e,f,g;return e={},f={},b={},d=function(a){return a instanceof u.Mesh?(f[a.uuid]=a,b[a.geometry.uuid]=a.geometry,e[a.material.uuid]=a.material):a instanceof u.Camera?console.log("camera",a):void 0},g=function(a){var b,c,e,f,h;if(a.children.length){for(f=a.children,h=[],c=0,e=f.length;e>c;c++)b=f[c],d(b),h.push(g(b));return h}},g(a),c={materials:e,geometries:b,meshes:f}},a.disposeIndex=function(a){var b;for(b in a.materials)a.materials[b]=null,delete a.materials[b];for(b in a.geometries)a.geometries[b]=null,delete a.geometries[b];for(b in a.meshes)a.meshes[b]=null,delete a.meshes[b];return null},a.exportCamera=function(b){var c;return c="",b instanceof u.PerspectiveCamera?(c+="camera {\n",c+="  type pinhole\n",c+="  eye "+a.exportVector(b.position)+"\n",c+="  target "+a.exportVector(b.rotation)+"\n",c+="  up "+a.exportVector(b.up)+"\n",c+="  fov 59\n",c+="  aspect "+b.aspect+"\n",c+="}\n\n"):console.log("Unsupported camera type"),c},a.exportShaders=function(b){var c,d;d="";for(c in b.materials)c=b.materials[c],d+="shader {\n",d+="  name "+c.uuid+"\n",d+="  type diffuse\n",d+="  diff "+a.exportColor(c.color)+"\n",d+="}\n\n";return d},a.exportObjects=function(b){var c,d,e,f,g,h,i,j,k,l,m;f="";for(d in b.geometries){for(d=b.geometries[d],f+="object {\n",f+="  noinstance\n",f+="  type generic-mesh\n",f+="  name "+d.uuid+"\n",f+="  points "+d.vertices.length+"\n",l=d.vertices,h=0,j=l.length;j>h;h++)g=l[h],f+="    "+a.exportVector(g)+"\n";for(f+="  triangles "+d.faces.length+"\n",m=d.faces,i=0,k=m.length;k>i;i++)c=m[i],f+="    "+a.exportFace(c)+"\n";f+="  normals none\n",f+="  uvs none\n",f+="}\n\n"}for(e in b.meshes)e=b.meshes[e],f+="instance {\n",f+="  name "+e.uuid+"\n",f+="  geometry "+e.geometry.uuid+"\n",f+=a.exportTransform(e),f+="  shader "+e.material.uuid+"\n",f+="}\n\n";return f},a.exportVector=function(a){return a.x+" "+a.y+" "+a.z},a.exportFace=function(a){return a.a+" "+a.b+" "+a.c},a.exportTransform=function(a){var b,c,d,e,f;for(c="",c+="  transform col",f=a.matrixWorld.elements,d=0,e=f.length;e>d;d++)b=f[d],c+=" "+b;return c+="\n"},a.exportColor=function(a){return'{ "sRGB nonlinear" '+a.r+" "+a.g+" "+a.b+" }"},a}(),v=function(a){function b(){b.__super__.constructor.call(this),this.settings={enabled:!0,diffusion:1,reflection:4,refraction:4}}return y(b,a),b.prototype.addToIndex=function(){return null},b.prototype.doTraverse=function(){return!0},b.prototype.exportBlock=function(){var a;return a="",this.settings.enabled?(a+="trace-depths {\n",a+="  diff "+this.settings.diffusion+"\n",a+="  refl "+this.settings.reflection+"\n",a+="  refr "+this.settings.refraction+"\n",a+="}\n\n"):a},b}(a),u.SF.InfinitePlaneGeometry=function(a,b,c,d){return a=a||1e4,b=b||1e4,c=c||100,d=d||100,console.log(a,b,c,d),u.PlaneGeometry.call(this)},u.SF.InfinitePlaneGeometry.prototype=Object.create(u.PlaneGeometry.prototype),u.SF.PointLight=p=function(a){function b(a,c,d){var e,f;b.__super__.constructor.call(this,a,c,d),u.PointLight.call(this),e=new u.SphereGeometry(6,3,3),f=new u.MeshBasicMaterial({color:255,wireframe:!0}),this.mesh=new u.Mesh(e,f),this.add(this.mesh)}return y(b,a),b}(u.PointLight),u.SF.SunskyLight=t=function(a){function b(a){b.__super__.constructor.call(this),a=a||{},this.up=a.up||new u.Vector3(0,1,0),this.east=a.east||new u.Vector3(0,0,1),this.direction=a.direction||new u.Vector3(1,1,1),this.turbidity=a.turbidity||6,this.samples=a.samples||64,this.directionalLight=new u.DirectionalLight(16777215,1),this.hemisphereLight=new u.HemisphereLight(16777215,3355443,1),this.add(this.directionalLight),this.add(this.hemisphereLight)}return y(b,a),b}(u.Object3D),u.SF.ConstantMaterial=d=function(a){function b(a){b.__super__.constructor.call(this),u.MeshPhongMaterial.call(this),this.setValues(a)}return y(b,a),b}(u.MeshPhongMaterial),u.SF.DiffuseMaterial=e=function(a){function b(a){b.__super__.constructor.call(this),u.MeshLambertMaterial.call(this),this.setValues(a)}return y(b,a),b}(u.MeshLambertMaterial),u.SF.GlassMaterial=i=function(a){function b(a){b.__super__.constructor.call(this),a=a||{},this.eta=a.eta||1,this.absorptionDistance=a.absorptionDistance||5,this.absorptionColor=typeof a.absorptionColor===u.Color?a.absorptionColor:new u.Color("number"==typeof a.absorptionColor?a.absorptionColor:16777215),u.MeshPhongMaterial.call(this),this.setValues(a)}return y(b,a),b}(u.MeshPhongMaterial),u.SF.MirrorMaterial=n=function(a){function b(a){b.__super__.constructor.call(this),a=a||{},this.reflection=typeof a.reflection===u.Color?a.reflection:new u.Color("number"==typeof a.reflection?a.reflection:16777215),u.MeshPhongMaterial.call(this),this.setValues(a)}return y(b,a),b}(u.MeshPhongMaterial),u.SF.PhongMaterial=o=function(a){function b(a){b.__super__.constructor.call(this),a=a||{},this.samples=a.samples||4,u.MeshPhongMaterial.call(this),this.setValues(a)}return y(b,a),b}(u.MeshPhongMaterial),u.SF.ShinyMaterial=r=function(a){function b(a){b.__super__.constructor.call(this),a=a||{},this.reflection=a.reflection||.5,u.MeshPhongMaterial.call(this),this.setValues(a)}return y(b,a),b}(u.MeshPhongMaterial)}).call(this);